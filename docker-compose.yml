version: "3.9"

services:

  # ================================
  # ZABBIX SERVER (PostgreSQL)
  # ================================
  zabbix-server:
    image: zabbix/zabbix-server-pgsql:alpine-latest
    container_name: zabbix-server
    environment:
      DB_SERVER_HOST: 192.168.15.6
      DB_SERVER_PORT: 5432
      POSTGRES_DB: cloudbooster_db
      POSTGRES_USER: cloud_user
      POSTGRES_PASSWORD: "37192541aaSS@"
      ZBX_DB_SCHEMA: zabbix
    ports:
      - "10051:10051"
    volumes:
      - ./zbx_data:/var/lib/zabbix
    depends_on:
      - zabbix-java-gateway
    restart: unless-stopped
    networks:
      - pi_default

  # ================================
  # ZABBIX FRONTEND (WEB INTERFACE)
  # ================================
  zabbix-frontend:
    image: zabbix/zabbix-web-nginx-pgsql:alpine-latest
    container_name: zabbix-frontend
    environment:
      DB_SERVER_HOST: 192.168.15.6
      DB_SERVER_PORT: 5432
      POSTGRES_DB: cloudbooster_db
      POSTGRES_USER: cloud_user
      POSTGRES_PASSWORD: "37192541aaSS@"
      DB_SCHEMA: zabbix
      PHP_TZ: America/Sao_Paulo
      ZBX_SERVER_HOST: zabbix-server
      ZBX_SERVER_PORT: 10051
    ports:
      - "8080:8080"   # <- A interface web abre nessa porta
    depends_on:
      - zabbix-server
    restart: unless-stopped
    networks:
      - pi_default

  # ================================
  # JAVA GATEWAY (necessário p/ JMX)
  # ================================
  zabbix-java-gateway:
    image: zabbix/zabbix-java-gateway:alpine-latest
    container_name: zabbix-java-gateway
    restart: unless-stopped
    networks:
      - pi_default

  # ================================
  # AGENT 1 (clássico)
  # ================================
  zabbix-agent1:
    image: zabbix/zabbix-agent:alpine-latest
    container_name: zabbix-agent1
    environment:
      ZBX_HOSTNAME: "raspberry-agent1"
      ZBX_SERVER_HOST: zabbix-server
      ZBX_LISTENPORT: 10050
    ports:
      - "10050:10050"
    depends_on:
      - zabbix-server
    restart: unless-stopped
    networks:
      - pi_default

  # ================================
  # AGENT 2 (moderno, com plugins)
  # ================================
  zabbix-agent2:
    image: zabbix/zabbix-agent2:alpine-latest
    container_name: zabbix-agent2
    environment:
      ZBX_HOSTNAME: "raspberry-agent2"
      ZBX_SERVER_HOST: zabbix-server
      ZBX_LISTENPORT: 10055
    ports:
      - "10055:10055"
    depends_on:
      - zabbix-server
    restart: unless-stopped
    networks:
      - pi_default

# ================================
# NETWORK EXTERNA (Portainer)
# ================================
networks:
  pi_default:
    external: true

# ================================
# VOLUME PERSISTENTE DO ZABBIX
# ================================
volumes:
  zbx_data:
